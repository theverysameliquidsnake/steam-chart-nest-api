<html lang="en" data-theme="light">
    <head>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
        <link rel="stylesheet" href="css/pico.colors.min.css">
        <style>
            .toast-success {
                border-left: 5px solid #398712 !important;
            }

            .toast-error {
                border-left: 5px solid #D93526 !important;
            }

            .toast-inner {
                margin: 0;
                padding: 1rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .toast-outer {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                min-width: 250px;
            }

            .toast-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .spinner {
                position: fixed;
                bottom: 20px;
                left: 20px;
                z-index: 1000;
                min-width: 250px;
            }

            .inline-checkbox-group {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 1rem;
            }

            .inline-checkbox-group label {
                display: flex;
                align-items: center;
                width: auto;
                margin-bottom: 0;
                white-space: nowrap;
            }

            .inline-checkbox-group input[type="checkbox"] {
                margin-bottom: 0;
                margin-inline-end: 0.5rem;
            }
        </style>
    </head>
    <body>
        <div class="container" x-data="data">
            <div x-show="toast.show" 
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-300"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-4"
                class="toast-outer">
                <article :class="toast.type === 'success' ? 'toast-success toast-inner' : 'toast-error toast-inner'">
                    <div class="toast-content">
                        <span x-text="toast.message"></span>
                    </div>
                </article>
            </div>
            <div x-show="spinner.show" aria-busy="true" class="spinner"></div>
            <nav>
                <ul>
                    <li><strong>Steam Analytics</strong></li>
                </ul>
                <ul>
                    <li><a href="#" @click="openChartsPage">Chart</a></li>
                    <li><a href="#" @click="openQueuePage">Queue</a></li>
                    <li><a href="#" @click="openLogsPage">Logs</a></li>
                    <li><a href="#" role="button" @click="openFileModal">Tags</a></li>
                    <li><a href="#" role="button" @click="triggerUpdates">Run</a></li>
                </ul>
            </nav>
            <div>
                <div x-show="navigation.isChartsPageOpen">
                    <canvas id="chart"></canvas>
                    <hr />
                    <details name="tagsGroup" open>
                        <summary role="button" class="outline">Tags</summary>
                        <div class="inline-checkbox-group">
                            <template x-for="tag in chart.tags">
                                <label>
                                    <input type="checkbox" :name="tag.name">
                                    <span x-text="tag.name"></span>
                                </label>
                            </template>
                        </div>
                    </details>
                </div>
                <div x-show="navigation.isQueuePageOpen">
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Name</th>
                                <th scope="col">Related To</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="job in jobs">
                                <tr>
                                    <th scope="row"><span x-text="job.id"></span></th>
                                    <th><span x-text="job.name"></span></th>
                                    <th><span x-text="job.data.appId"></span></th>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="navigation.isLogsPageOpen">
                    <table>
                        <thead>
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">Level</th>
                                <th scope="col">Related To</th>
                                <th scope="col">Message</th>
                                <th scope="col">Created At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="log in logs">
                                <tr>
                                    <th scope="row"><span x-text="log.id"></span></th>
                                    <th><span x-text="log.level"></span></th>
                                    <th><span x-text="log.relatedTo"></span></th>
                                    <th><span x-text="log.message"></span></th>
                                    <th><span x-text="log.createdAt"></span></th>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                <div x-show="tags.showModal">
                    <dialog open>
                        <article>
                            <header>
                                <button aria-label="Close" rel="prev" @click="closeFileModal"></button>
                                <p><strong>File Uploader</strong></p>
                            </header>
                            <p>Please upload .html file from SteamDB with all available tags.</p>
                            <input type="file" x-ref="fileInput">
                            <footer>
                                <button class="secondary" @click="closeFileModal">Cancel</button>
                                <button @click="uploadFile">Upload</button>
                            </footer>
                        </article>
                    </dialog>
                </div>
            </div>
            <script>
                function constructLabels(labels) {
                    labels.push('Soon');
                    return labels;
                }

                function constructDataset(label, labels, data, comingSoon) {
                    const dataset = [];
                    for (const elem of labels) {
                        dataset.push(data[elem] ? data[elem] : 0);
                    }
                    dataset.push(comingSoon);

                    return {
                        label: label,
                        data: dataset,
                        borderWidth: 1
                    };
                }

                document.addEventListener('alpine:init', () => {
                    Alpine.data('data', () => ({
                        chart: {
                            tags: [],
                            selectedTags: [],
                            data: {}
                        },

                        renderTags() {
                            this.showSpinner();
                            fetch('/api/tag', {
                                method: 'GET',
                            }).then((response) => {
                                if (response.status !== 200) {
                                    this.chart.tags = [];
                                    console.log(response);
                                    throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                }

                                return response.json();
                            }).then((data) => {
                                this.chart.tags = data.map((tag) => {
                                    return { name: tag.name, id: tag.id };
                                });
                                this.showToast('Loaded tag list!', 'success');
                            }).catch((error) => {
                                console.error(error);
                                this.showToast(`Error: ${error}.`, 'error');
                            }).finally(() => {
                                this.hideSpinner();
                            });
                        },

                        renderChart() {
                            this.showSpinner();
                            fetch('/api/chart', {
                                method: 'GET',
                            }).then((response) => {
                                if (response.status !== 200) {
                                    this.chart.data = {};
                                    console.log(response);
                                    throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                }

                                return response.json();
                            }).then((data) => {
                                this.chart.data = data;
                                const labels = constructLabels(Object.keys(this.chart.data.base.years));
                                const mainDataset = constructDataset('# of Overall Games', labels, this.chart.data.base.years, this.chart.data.base.coming_soon);
                                const ctx = document.getElementById('chart');

                                const ghostChart = Chart.getChart('chart');
                                if (ghostChart) {
                                    ghostChart.destroy();
                                }
                                
                                new Chart(ctx, {
                                    type: 'bar',
                                    data: {
                                        labels: labels,
                                        datasets: [mainDataset]
                                    },
                                    options: {
                                        scales: {
                                            y: {
                                                beginAtZero: true
                                            }
                                        }
                                    }
                                });
                                this.showToast('Loaded available chart data!', 'success');
                            }).catch((error) => {
                                console.error(error);
                                this.showToast(`Error: ${error}.`, 'error');
                            }).finally(() => {
                                this.hideSpinner();
                            });
                        },

                        jobs: [],

                        loadJobs() {
                            this.showSpinner();
                            fetch('/api/queue', {
                                method: 'GET',
                            }).then((response) => {
                                if (response.status !== 200) {
                                    this.jobs = [];
                                    console.log(response);
                                    throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                }

                                return response.json();
                            }).then((data) => {
                                this.jobs = data;
                                this.showToast('Loaded waiting jobs!', 'success');
                            }).catch((error) => {
                                console.error(error);
                                this.showToast(`Error: ${error}.`, 'error');
                            }).finally(() => {
                                this.hideSpinner();
                            });
                        },

                        logs: [],

                        loadLogs() {
                            this.showSpinner();
                            fetch('/api/log', {
                                method: 'GET',
                            }).then((response) => {
                                if (response.status !== 200) {
                                    this.logs = [];
                                    console.log(response);
                                    throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                }

                                return response.json();
                            }).then((data) => {
                                this.logs = data;
                                this.showToast('Loaded last 50 logs!', 'success');
                            }).catch((error) => {
                                console.error(error);
                                this.showToast(`Error: ${error}.`, 'error');
                            }).finally(() => {
                                this.hideSpinner();
                            });
                        },

                        navigation: {
                            isChartsPageOpen: false,
                            isMissedPageOpen: false,
                            isQueuePageOpen: false,
                            isLogsPageOpen: false
                        },

                        closeAll() {
                            this.navigation.isChartsPageOpen = false;
                            this.navigation.isMissedPageOpen = false;
                            this.navigation.isQueuePageOpen = false;
                            this.navigation.isLogsPageOpen = false;
                        },

                        async openChartsPage() {
                            this.closeAll();
                            this.navigation.isChartsPageOpen = true;

                            await this.renderTags();
                            this.chart.tags = [];
                            this.chart.selectedTags = [];

                            this.renderChart();
                        },

                        openMissedPage() {
                            this.closeAll();
                            this.navigation.isMissedPageOpen = true;
                        },

                        openQueuePage() {
                            this.closeAll();
                            this.navigation.isQueuePageOpen = true;

                            this.loadJobs();
                        },

                        openLogsPage() {
                            this.closeAll();
                            this.navigation.isLogsPageOpen = true;

                            this.loadLogs();
                        },

                        tags: {
                            showModal: false
                        },

                        openFileModal() {
                            this.tags.showModal = true;
                        },

                        closeFileModal() {
                            this.tags.showModal = false;

                            if (this.$refs.fileInput) {
                                this.$refs.fileInput.value = '';
                            }
                        },

                        uploadFile() {
                            const file = this.$refs.fileInput.files[0];
                            if (file) {
                                const formData = new FormData();
                                formData.append('file', file);

                                this.showSpinner();
                                fetch('/api/file', {
                                    method: 'POST',
                                    body: formData
                                }).then((response) => {
                                    if (response.status !== 201) {
                                        console.log(response);
                                        throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                    }

                                    return fetch('/api/tag', {
                                        method: 'POST'
                                    });
                                }).then((response) => {
                                    if (response.status !== 201) {
                                        console.log(response);
                                        throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                    }

                                    return response.json();
                                }).then((data) => {
                                    this.showToast(`Added ${data.length} tags!`, 'success');
                                    this.closeFileModal();
                                }).catch((error) => {
                                    console.error(error);
                                    this.showToast(`Error: ${error}.`, 'error');
                                }).finally(() => {
                                    this.hideSpinner();
                                });
                            }
                        },

                        triggerUpdates() {
                            this.showSpinner();
                            fetch('/api/steam', {
                                method: 'POST'
                            }).then((response) => {
                                if (response.status !== 201) {
                                    console.log(response);
                                    throw new Error(`Unexpected response code: ${response.status}. Check console for details.`)
                                }

                                this.showToast(`Started update!`, 'success');
                            }).catch((error) => {
                                console.error(error);
                                this.showToast(`Error: ${error}.`, 'error');
                            }).finally(() => {
                                this.hideSpinner();
                            });
                        },

                        toast: {
                            show: false,
                            message: '',
                            type: '',
                        },

                        showToast(message, type) {
                            this.toast.message = message;
                            this.toast.type = type;
                            this.toast.show = true;

                            setTimeout(() => {
                                this.toast.show = false;
                            }, 3000);
                        },

                        spinner: {
                            show: false,
                        },

                        showSpinner() {
                            this.spinner.show = true;
                        },

                        hideSpinner() {
                            this.spinner.show = false;
                        },

                        async init() {
                            await this.openChartsPage();
                        }
                    }));
                });
            </script>
        </div>
    </body>
</html>