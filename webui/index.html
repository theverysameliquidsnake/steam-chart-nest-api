<html lang="en" data-theme="light">
    <head>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
        <link rel="stylesheet" href="css/pico.colors.min.css">
        <style>
            .toast-success {
                border-left: 5px solid #398712 !important;
                background-color: var(--card-background-color);
            }

            .toast-error {
                border-left: 5px solid #D93526 !important;
                background-color: var(--card-background-color);
            }

            .toast-inner {
                margin: 0;
                padding: 1rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .toast-outer {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                min-width: 250px;
            }

            .toast-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container" x-data="data">
            <div x-show="toast.show" 
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-300"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-4"
                class="toast-outer">
                <article :class="toast.type === 'success' ? 'toast-success toast-inner' : 'toast-error toast-inner'">
                    <div class="toast-content">
                        <span x-text="toast.message"></span>
                    </div>
                </article>
            </div>
            <nav>
                <ul>
                    <li><strong>Steam Analytics</strong></li>
                </ul>
                <ul>
                    <li><a href="#" @click="openChartsPage">Charts</a></li>
                    <li><a href="#" @click="openMissedPage">Missed</a></li>
                    <li><a href="#" @click="openLogsPage">Logs</a></li>
                    <li><a href="#" role="button" @click="openFileModal">File</a></li>
                    <li><a href="#" role="button">Tags</a></li>
                    <li><a href="#" role="button">Run</a></li>
                </ul>
            </nav>
            <div>
                <div x-show="navigation.isChartsPageOpen">
                    <div class="grid">
                        <div><canvas id="myChart1"></canvas></div>
                        <div><canvas id="myChart2"></canvas></div>
                    </div>
                    <div class="grid">
                        <div><canvas id="myChart3"></canvas></div>
                        <div><canvas id="myChart4"></canvas></div>
                    </div>
                </div>
                <div x-show="navigation.isFileModalOpen">
                    <dialog open>
                        <article>
                            <header>
                                <button aria-label="Close" rel="prev" @click="closeFileModal"></button>
                                <p><strong>File Uploader</strong></p>
                            </header>
                            <p>Please upload .html file from SteamDB with all available tags.</p>
                            <input type="file" x-ref="fileInput">
                            <footer>
                                <button class="secondary" @click="closeFileModal">Cancel</button>
                                <button @click="uploadFile">Upload</button>
                            </footer>
                        </article>
                    </dialog>
                </div>
            </div>
            <script>
                function renderChart(elemId) {
                    const ctx = document.getElementById(elemId);

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                            datasets: [{
                                label: '# of Votes',
                                data: [12, 19, 3, 5, 2, 3],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                document.addEventListener('alpine:init', () => {
                    Alpine.data('data', () => ({
                        navigation: {
                            isChartsPageOpen: true,
                            isMissedPageOpen: false,
                            isLogsPageOpen: false,
                            isFileModalOpen: false,
                        },
                        toast: {
                            show: false,
                            message: '',
                            type: '',
                        },

                        showToast(message, type) {
                            this.toast.message = message;
                            this.toast.type = type;
                            this.toast.show = true;

                            setTimeout(() => {
                                this.toast.show = false;
                            }, 3000);
                        },

                        openChartsPage() {
                            this.navigation.isChartsPageOpen = true;
                            this.navigation.isMissedPageOpen = false;
                            this.navigation.isLogsPageOpen = false;
                        },

                        openMissedPage() {
                            this.navigation.isChartsPageOpen = false;
                            this.navigation.isMissedPageOpen = true;
                            this.navigation.isLogsPageOpen = false;
                        },

                        openLogsPage() {
                            this.navigation.isChartsPageOpen = false;
                            this.navigation.isMissedPageOpen = false;
                            this.navigation.isLogsPageOpen = true;
                        },

                        openFileModal() {
                            this.navigation.isFileModalOpen = true;
                        },

                        closeFileModal() {
                            this.navigation.isFileModalOpen = false;

                            if (this.$refs.fileInput) {
                                this.$refs.fileInput.value = '';
                            }
                        },

                        async uploadFile() {
                            const file = this.$refs.fileInput.files[0];
                            if (file) {
                                const formData = new FormData();
                                formData.append('file', file);

                                try {
                                    const response = await fetch('/api/file', {
                                        method: 'POST',
                                        body: formData
                                    });

                                    if (response.status === 201) {
                                        this.showToast('Uploaded file!', 'success');
                                        this.closeFileModal();
                                    } else {
                                        console.log(response);
                                        this.showToast(`Unexpected response code: ${response.status}. Check console for details.`, 'error');
                                    }
                                } catch (error) {
                                    console.error(error);
                                    this.showToast(`Unexpected error. Check console for details.`, 'error');
                                }
                            }
                        }
                    }));

                    renderChart('myChart1');
                    renderChart('myChart2');
                    renderChart('myChart3');
                    renderChart('myChart4');
                });
            </script>
        </div>
    </body>
</html>